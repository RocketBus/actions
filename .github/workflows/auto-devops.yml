name: Auto DevOps

on:
  workflow_call:
    inputs:
      type:
        type: string
        required: false
        default: application
      build_once:
        type: string
        required: false
        default: 'true'
      autodetect_buildpacks:
        type: string
        required: false
        default: 'true'
      buildpacks:
        type: string
        required: false
      node_version:
        type: string
        required: false
        default: '18'
      node_package_manager:
        type: string
        required: false
        default: yarn
      jdk_version:
        type: string
        required: false
        default: '17'
      docker_image_name:
        type: string
        required: false
      dockerfile_path:
        type: string
        required: false
        default: Dockerfile
      docker_build_context:
        type: string
        required: false
        default: .
      docker_build_target:
        type: string
        required: false
      docker_build_args:
        type: string
        required: false
      chart_path:
        type: string
        required: false
        default: charts
      chart_name:
        type: string
        required: false
    secrets:
      sonar_token:
        required: false
      slack_app_token:
        required: false
      slack_bot_token:
        required: false
      slack_signing_secret:
        required: false

env:
  CI: true
  ACTIONS_IAM_ROLE: ${{ vars.ACTIONS_IAM_ROLE }}
  CODEARTIFACT_DOMAIN: ${{ vars.CODEARTIFACT_DOMAIN }}
  CODEARTIFACT_DOMAIN_OWNER: ${{ vars.CODEARTIFACT_DOMAIN_OWNER }}
  CODEARTIFACT_REGION: ${{ vars.CODEARTIFACT_REGION }}
  SONAR_TOKEN: ${{ secrets.sonar_token }}
  SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
  AUTODETECT_BUILDPACKS: ${{ inputs.autodetect_buildpacks }}
  BUILDPACKS: ${{ inputs.buildpacks }}
  NODE_VERSION: ${{ inputs.node_version }}
  NODE_PACKAGE_MANAGER: ${{ inputs.node_package_manager }}
  NODE_OPTIONS: "--max_old_space_size=3072"
  NODE_ENV: production
  JDK_VERSION: ${{ inputs.jdk_version }}
  MAVEN_CLI_OPTS: "-B -Dstyle.color=always -e -fae -ntp -U -V"
  MAVEN_OPTS: "-Xmx1024m -Xms512m -Dhttps.protocols=TLSv1.2 -Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss,SSS -Djava.awt.headless=true"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"
  DOCKER_IMAGE_NAME: ${{ inputs.docker_image_name || github.event.repository.name }}
  DOCKERFILE_PATH: ${{ inputs.dockerfile_path }}
  DOCKER_BUILD_CONTEXT: ${{ inputs.docker_build_context }}
  DOCKER_BUILD_TARGET: ${{ inputs.docker_build_target }}
  DOCKER_BUILD_ARGS: ${{ inputs.docker_build_args }}
  DOCKER_SCAN_FAIL_BUILD: false
  DOCKER_SCAN_SEVERITY_CUTOFF: medium
  ECR_REGION: ${{ vars.ECR_REGION }}
  HELM_VERSION: '3.12.1'
  CHART_PATH: ${{ inputs.chart_path }}
  CHART_NAME: ${{ inputs.chart_name || github.event.repository.name }}
  ENV_SPEC: ${{ vars.ENV_SPEC }}

jobs:
  build:
    name: Build
    runs-on: live
    outputs:
      gitversion_prereleasenumber: ${{ steps.gitversion.outputs.PreReleaseNumber }}
      gitversion_majorminorpatch: ${{ steps.gitversion.outputs.MajorMinorPatch }}
      gitversion_semver: ${{ steps.gitversion.outputs.SemVer }}
    strategy:
      fail-fast: true
      matrix:
        environment: ${{ inputs.build_once && fromJson('[""]') || ((github.ref_name == 'cabal' || github.ref_name == 'fallen' || github.ref_name == 'hive' || github.ref_name == 'taken' || github.ref_name == 'vex') && fromJson('["github.ref_name"]') || github.ref_name == github.event.repository.default_branch && fromJson('["stg", "live"]')) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up .NET cli
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'
        env:
          DOTNET_INSTALL_DIR: ~/.local/share/dotnet

      - name: Set up GitVersion
        uses: gittools/actions/gitversion/setup@v0
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0

      - name: Lint
        uses: RocketBus/actions/.github/actions/stages/lint@v1
        with:
          yarnrc: ${{ vars.YARNRC }}
          npmrc: ${{ vars.NPMRC }}
          maven_settings: ${{ vars.MAVEN_SETTINGS }}

      - name: Build
        uses: RocketBus/actions/.github/actions/stages/build@v1
        with:
          yarnrc: ${{ vars.YARNRC }}
          npmrc: ${{ vars.NPMRC }}
          maven_settings: ${{ vars.MAVEN_SETTINGS }}
        env:
          NODE_BUILD_ENV: ${{ matrix.environment }}
          VERSION_SUFFIX: ${{ matrix.environment }}

  test:
    name: Test
    runs-on: live
    needs:
      - build
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Test
        uses: RocketBus/actions/.github/actions/stages/test@v1
        with:
          yarnrc: ${{ vars.YARNRC }}
          npmrc: ${{ vars.NPMRC }}
          maven_settings: ${{ vars.MAVEN_SETTINGS }}
        env:
          GITVERSION_PRERELEASENUMBER: ${{ needs.build.outputs.gitversion_prereleasenumber }}
          GITVERSION_MAJORMINORPATCH: ${{ needs.build.outputs.gitversion_majorminorpatch }}
          GITVERSION_SEMVER: ${{ needs.build.outputs.gitversion_semver }}

  release:
    name: Release
    if: ${{ github.event_name == 'push' }}
    runs-on: live
    needs:
      - build
      - test
    strategy:
      fail-fast: true
      matrix:
        environment: ${{ inputs.build_once && fromJson('[""]') || ((github.ref_name == 'cabal' || github.ref_name == 'fallen' || github.ref_name == 'hive' || github.ref_name == 'taken' || github.ref_name == 'vex') && fromJson('["github.ref_name"]') || github.ref_name == github.event.repository.default_branch && fromJson('["stg", "live"]')) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Release
        uses: RocketBus/actions/.github/actions/stages/release@v1
        with:
          yarnrc: ${{ vars.YARNRC }}
          npmrc: ${{ vars.NPMRC }}
          maven_settings: ${{ vars.MAVEN_SETTINGS }}
        env:
          GITVERSION_PRERELEASENUMBER: ${{ needs.build.outputs.gitversion_prereleasenumber }}
          GITVERSION_MAJORMINORPATCH: ${{ needs.build.outputs.gitversion_majorminorpatch }}
          GITVERSION_SEMVER: ${{ needs.build.outputs.gitversion_semver }}
          NODE_BUILD_ENV: ${{ matrix.environment }}
          VERSION_SUFFIX: ${{ matrix.environment }}

  development:
    name: Development
    if: ${{ github.event_name == 'push' && (github.ref_name == 'cabal' || github.ref_name == 'fallen' || github.ref_name == 'hive' || github.ref_name == 'taken' || github.ref_name == 'vex') && inputs.type == 'application' }}
    environment:
      name: ${{ (github.ref_name == 'cabal' || github.ref_name == 'fallen' || github.ref_name == 'hive' || github.ref_name == 'taken' || github.ref_name == 'vex') && github.ref_name }}
    runs-on: live
    needs:
      - release
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Deploy
        uses: RocketBus/actions/.github/actions/stages/deploy@v1
        env:
          CHART_VERSION: ${{ needs.release.outputs.chart_version }}
          ENVIRONMENT: ${{ (github.ref_name == 'cabal' || github.ref_name == 'fallen' || github.ref_name == 'hive' || github.ref_name == 'taken' || github.ref_name == 'vex') && github.ref_name }}

  staging:
    name: Staging
    if: ${{ github.event_name == 'push' && github.ref_name == github.event.repository.default_branch && inputs.type == 'application' }}
    environment:
      name: staging
    runs-on: live
    needs:
      - release
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Deploy
        uses: RocketBus/actions/.github/actions/stages/deploy@v1
        env:
          CHART_VERSION: ${{ needs.release.outputs.chart_version }}
          ENVIRONMENT: stg
          VERSION_SUFFIX: ${{ inputs.build_once || 'stg' }}

  zaproxy:
    name: ZAP Scan
    if: ${{ needs.staging.outputs.url }}
    runs-on: live
    needs:
      - staging
    steps:
      - name: ZAP Scan
        uses: zaproxy/action-full-scan@v0.5.1
        with:
          target: ${{ needs.staging.outputs.url }}