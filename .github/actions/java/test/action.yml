name: 'Maven Test'
description: ''

runs:
  using: "composite"
  steps:
    - name: Set up Maven
      uses: RocketBus/actions/.github/actions/java/setup@v1

    - name: Run Unit Tests
      shell: bash
      run: ./mvnw $MAVEN_CLI_OPTS verify -Dspotless.check.skip=true -DskipITs=true -Dsonar.skip=true

    - name: Run Integration Tests
      shell: bash
      run: ./mvnw $MAVEN_CLI_OPTS verify -Dspotless.check.skip=true -DskipUTs=true -Dsonar.skip=true

    - name: Set up SonarQube Args
      id: setup_sonar_args
      shell: bash
      run: |
        if [[ ${{ github.event_name }} == 'pull_request' ]]; then
          SONAR_ARGS="-Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
            -Dsonar.pullrequest.branch=${{ github.head_ref }} \
            -Dsonar.pullrequest.base=${{ github.base_ref }}
            -Dsonar.pullrequest.github.repository=$GITHUB_REPOSITORY"
        elif [[ ${{ github.event_name }} == 'push' && ${{ github.ref_name }} != ${{ github.event.repository.default_branch }} ]]; then
          SONAR_ARGS="-Dsonar.branch.name=${{ github.ref_name }}"
        fi

        echo "args=$SONAR_ARGS" >> $GITHUB_OUTPUT

    - name: SonarQube Scan
      shell: bash
      run: ./mvnw $MAVEN_CLI_OPTS sonar:sonar ${{ steps.setup_sonar_args.outputs.args }}
      env:
        SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

    - name: SonarQube Quality Gate
      uses: sonarsource/sonarqube-quality-gate-action@master
      env:
        SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}