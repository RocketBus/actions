name: 'Gradle Test'
description: ''

inputs:
  sonar_args:
    description: ''
    required: false

runs:
  using: "composite"
  steps:
    - name: Set up Gradle
      uses: RocketBus/actions/.github/actions/gradle/setup@v1

    - name: Run Tests
      shell: bash
      run: ./gradlew test jacocoTestReport

    - name: Set up SonarQube Args
      id: setup_sonar_args
      shell: bash
      run: |
        if [[ ${{ github.event_name }} == 'pull_request' ]]; then
          SONAR_ARGS="-Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
            -Dsonar.pullrequest.branch=${{ github.head_ref }} \
            -Dsonar.pullrequest.base=${{ github.base_ref }}
            -Dsonar.pullrequest.github.repository=$GITHUB_REPOSITORY"
        elif [[ ${{ github.event_name }} == 'push' && ${{ github.ref_name }} != ${{ github.event.repository.default_branch }} ]]; then
          SONAR_ARGS="-Dsonar.branch.name=${{ github.ref_name }}"
        fi

        echo "args=$SONAR_ARGS" >> $GITHUB_OUTPUT

    - name: SonarQube Scan
      shell: bash
      run: ./gradlew sonar ${{ steps.setup_sonar_args.outputs.args }}
      env:
        SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

    - name: SonarQube Quality Gate
      uses: sonarsource/sonarqube-quality-gate-action@master
      env:
        SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}