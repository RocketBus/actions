name: 'Node.js Test'
description: ''

runs:
  using: "composite"
  steps:
    - name: Set up Node.js
      uses: RocketBus/actions/.github/actions/nodejs/setup@v1

    - name: Run Tests
      if: ${{ inputs.package_management == 'npm' }}
      shell: bash
      run: npm run test

    - name: Run Tests
      if: ${{ inputs.package_management == 'yarn' }}
      shell: bash
      run: yarn run test

    - name: Set up SonarQube Args
      id: setup_sonar_args
      shell: bash
      run: |
        if [[ ${{ github.event_name }} == 'pull_request' ]]; then
          SONAR_ARGS="-Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
            -Dsonar.pullrequest.branch=${{ github.head_ref }} \
            -Dsonar.pullrequest.base=${{ github.base_ref }}
            -Dsonar.pullrequest.github.repository=$GITHUB_REPOSITORY"
        elif [[ ${{ github.event_name }} == 'push' && ${{ github.ref_name }} != ${{ github.event.repository.default_branch }} ]]; then
          SONAR_ARGS="-Dsonar.branch.name=${{ github.ref_name }}"
        fi

        echo "args=$SONAR_ARGS" >> $GITHUB_OUTPUT

    - name: SonarQube Scan
      uses: sonarsource/sonarqube-scan-action@master
      with:
        args: ${{ steps.setup_sonar_args.outputs.args }}
      env:
        SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

    - name: SonarQube Quality Gate
      uses: sonarsource/sonarqube-quality-gate-action@master
      env:
        SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}